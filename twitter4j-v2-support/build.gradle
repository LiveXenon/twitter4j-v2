plugins {
    // Apply the Kotlin JVM plugin to add support for Kotlin.
    id 'org.jetbrains.kotlin.jvm'

    // Apply the java-library plugin for API and implementation separation.
    id 'java-library'
}
apply plugin: 'com.jfrog.bintray'

repositories {
    jcenter()
}

dependencies {

    implementation "org.twitter4j:twitter4j-core:4.0.7"

    // Align versions of all Kotlin components
    implementation platform('org.jetbrains.kotlin:kotlin-bom')
    implementation 'org.jetbrains.kotlin:kotlin-stdlib-jdk8'

    testImplementation 'org.jetbrains.kotlin:kotlin-test'
    testImplementation 'org.jetbrains.kotlin:kotlin-test-junit'
    testImplementation "org.assertj:assertj-core:3.16.1"

}

//--------------------------------------------------
// for publish
//--------------------------------------------------
// $ ./gradlew publishToMavenLocal  # deploy to ~/.m2/repository/jp/takke/twitter4j-v2/twitter4j-v2-support/
apply plugin: 'maven-publish'

// custom tasks for creating source/javadoc jars
task sourcesJar(type: Jar, dependsOn: classes) {
    archiveClassifier.set('sources')
    from sourceSets.main.allSource
}

task javadocJar(type: Jar, dependsOn: javadoc) {
    archiveClassifier.set('javadoc')
    from javadoc.destinationDir
}

// add javadoc/source jar tasks as artifacts
artifacts {
    archives sourcesJar, javadocJar
}

def pomConfig = {
    licenses {
        license {
            name "The Apache Software License, Version 2.0"
            url "http://www.apache.org/licenses/LICENSE-2.0.txt"
            distribution "repo"
        }
    }
    developers {
        developer {
            id "takke"
            name "Hiroaki TAKEUCHI"
            email "takke30@gmail.com"
        }
    }

    scm {
        url scmUrl
    }
}

publishing {
    publications {
        MyPublication(MavenPublication) {
            from components.java
            artifact sourcesJar
            artifact javadocJar
            groupId groupName
            version versionName

            pom.withXml {
                def root = asNode()
                root.appendNode('description', descriptionText)
                root.appendNode('name', 'twitter4j-v2')
                root.appendNode('url', scmUrl)
                root.children().last() + pomConfig
            }
        }
    }
}

//--------------------------------------------------
// upload to bintray
//--------------------------------------------------
// ./gradlew clean bintrayUpload
bintray {
    user = hasProperty('bintrayUser') ? project.property('bintrayUser') : System.getenv('BINTRAY_USER')
    key = hasProperty('bintrayApiKey') ? project.property('bintrayApiKey') : System.getenv('BINTRAY_API_KEY')

    // false => push upload button on bintray web page to distribute new version manually.
    publish = false

//    configurations = ['MyPublication']

    pkg {
        repo = 'maven'
        name = 'twitter4j-v2'
        userOrg = user
        licenses = ['Apache-2.0']
        labels = ['kotlin']
        vcsUrl = vcsUrl
        version {
            name = versionName
            desc = versionDescription
            vcsTag = versionName
        }
    }
}

bintrayUpload.doFirst {
    publications = publishing.publications.collect {
        it.name
    }
}

bintrayUpload.dependsOn publishToMavenLocal
